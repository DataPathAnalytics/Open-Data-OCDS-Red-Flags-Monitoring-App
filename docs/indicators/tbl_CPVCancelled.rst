.. _tbl_CPVCancelled:

tbl_tbl_CPVCancelled
====================

Данная аналитическая таблица хранит идентификаторы закупающих организаций и коды предметов закупок из отмененных ими закупок и отдельных лотов с самыми поздними датами этих отмен.

Данная аналитическая таблица содержит следующую информацию:
 - Идентификатор закупающей организации.
 - Код предмета закупки.
 - Дата отмены.
 
Пример того, как может выглядеть таблица:

================== ====================== =============
Идентификатор ЗО   Код предмета закупки   Дата отмены
------------------ ---------------------- -------------
Идентификатор ЗО 1 Код предмета закупки 1 Дата отмены 1
Идентификатор ЗО 1 Код предмета закупки 2 Дата отмены 2
Идентификатор ЗО 1 Код предмета закупки 3 Дата отмены 3
Идентификатор ЗО 2 Код предмета закупки 4 Дата отмены 4
Идентификатор ЗО 2 Код предмета закупки 5 Дата отмены 5
...                ...                    ... 
================== ====================== =============

****************************
Расчет аналитической таблицы
****************************

****************************
Источники данных для расчета
****************************

Для расчета аналитической таблицы используются следующие источники данных:

- API системы государственных закупок в OCDS формате.

*************************************
Частота расчета аналитической таблицы
*************************************

Аналитическая таблица рассчитывается 1 раз в сутки.

****************
Поля для расчета
****************

- ``data.tender.procurementMethodDetails``
- ``data.tender.status``
- ``data.tender.date``
- ``data.tender.lots.id``
- ``data.tender.lots.status``
- ``data.tender.items.relatedLot``
- ``data.tender.items.classification.id``
- ``data.parties.id``
- ``data.parties.roles``

***********************
Формула расчета таблицы
***********************

1. Перед расчетом таблица очищается.

2. Выбираем только процедуры, у которых ``data.tender.procurementMethodDetails`` принимает одно из значений: ``oneStage``, ``simplicated``, ``downgrade``.

3. Выбираем все лоты полностью отмененных процедур ``data.tender.status = 'cancelled'`` и отмененные лоты ``data.tender.lots.status = 'cancelled'`` завершенных процедур. Завершенными считаем процедуры, что находятся в статусе ``data.tender.status = 'complete'``, или те, что находятся в статусе ``data.tender.status = 'active'``, но имеют ``statusDetails = 'evaluationComplete'`` более 30 дней.

4. Выбираем идентификатор закупающей организации - ``data.parties.id`` объекта, у которого ``data.parties.roles='procuringEntity'``

5. Выбираем все лоты, у которых ``data.tender.lots.status='active'``. Для каждого такого лота проводим следующие действия.

6. Для каждого лота выбираем все коды предметов закупки - ``data.tender.items.classification.id``, связанных с лотом по ``data.tender.items.relatedLot=data.tender.lots.id``

7. Для каждого лота определяем дату его отмены, как ``data.tender.date``.

8. Проведя п.1-п.7 по всем лотам, подходящим по условиям, группируем итоговые данные по идентификатору закупающей организации, коду предмета закупки и выбираем для них самую позднюю дату отмены из п.7.
